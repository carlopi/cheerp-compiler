version: 2.1

aliases:
  - &ubuntu
    image: ubuntu-2004:202111-02

jobs:
  define-version-no:
    machine: *ubuntu
    resource_class: medium
    steps:
      - run: mkdir -p ~/project/packages
      - run:
          name: Define version
          command: |
            if [ << pipeline.parameters.tag >> != 'master' ]; then
              export VERSION_NO=`echo << pipeline.parameters.tag >> | cut --complement -c1-7 | sed "s/rc/~rc/"`
            else
              export VERSION_NO=`date +%s`
            fi
            echo "export VERSION_NO=$VERSION_NO" >> packages/version
      - persist_to_workspace:
          root: ~/project/packages
          paths:
              - version
  build-cheerp-compiler:
    machine: *ubuntu
    resource_class: large
    environment:
      - NINJA_STATUS: "[%u/%r/%f] "
    steps:
      - attach_workspace:
          at: packages
      - run: sudo apt-get update && sudo apt-get install -y debhelper cmake ninja-build clang lld devscripts
      - run:
          name: Clone Cheerp
          command: |
            if [ << pipeline.parameters.tag >> != 'master' ]; then
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-compiler
            else
              git clone --depth=1 --branch << pipeline.parameters.cheerp-compiler-branch >> https://github.com/leaningtech/cheerp-compiler
            fi
      - run:
          name: Set up environment
          working_directory: ~/project/cheerp-compiler
          command: |
            cat ~/project/packages/version >> $BASH_ENV
      - run:
          name: Build cheerp compiler
          working_directory: ~/project/cheerp-compiler
          command: |
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            dpkg-buildpackage -b -d
      - run:
          name: Store package
          working_directory: ~/project
          command: |
            mv cheerp-llvm-clang_*.deb packages/
      - persist_to_workspace:
          root: ~/project/packages
          paths:
            - cheerp-llvm-clang_*.deb
  build-libraries:
    machine: *ubuntu
    resource_class: medium
    environment:
      - NINJA_STATUS: "[%u/%r/%f] "
    steps:
      - run: sudo apt-get update && sudo apt-get install -y debhelper cmake python3-distutils ninja-build clang lld devscripts
      - attach_workspace:
          at: packages
      - run:
          name: Get repos
          command: |
            if [ << pipeline.parameters.tag >> != master ]; then
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-compiler.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-newlib.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-libs.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-utils.git
            else
              git clone --depth=1 --branch << pipeline.parameters.cheerp-compiler-branch >> https://github.com/leaningtech/cheerp-compiler.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-newlib-branch >> https://github.com/leaningtech/cheerp-newlib.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-libs-branch >> https://github.com/leaningtech/cheerp-libs.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-utils-branch >> https://github.com/leaningtech/cheerp-utils.git
            fi
      - run:
          name: Set up workspace
          command: |
            cat ~/project/packages/version >> $BASH_ENV
      - run:
          name: Set up cheerp compiler
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-llvm-clang_*.deb tmp
            sudo mkdir /opt/cheerp/
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp
            rm -rf tmp
      - run:
          name: Build utils
          working_directory: ~/project/cheerp-utils
          command: |
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            dpkg-buildpackage -d -b
            mkdir tmp
            dpkg -x ../cheerp-utils_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/

            mv ../cheerp-utils_*.deb ../packages/
      - run:
          name: Build newlib
          working_directory: ~/project/cheerp-newlib
          command: |
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            cp -rv ../cheerp-compiler/libcxx/ libcxx/
            dpkg-buildpackage -d -b
            mkdir tmp
            dpkg -x ../cheerp-newlib_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/

            mv ../cheerp-newlib_*.deb ../packages/
      - run:
          name: Build libcxx
          working_directory: ~/project/cheerp-compiler
          command: |
            rm -rf debian/
            cp -rv libcxx/debian/ debian/
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            dpkg-buildpackage -d -b
            mkdir tmp
            dpkg -x ../cheerp-libcxx_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf build_genericjs/
            rm -rf build_asmjs/
            rm -rf debian/
            rm -rf tmp

            mv ../cheerp-libcxx_*.deb ../packages/
      - run:
          name: Build libcxxabi
          working_directory: ~/project/cheerp-compiler
          command: |
            cp -rv libcxxabi/debian/ debian/
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            dpkg-buildpackage -d -b
            mkdir tmp
            dpkg -x ../cheerp-libcxxabi_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp

            mv ../cheerp-libcxxabi_*.deb ../packages/
      - run:
          name: Build libs
          working_directory: ~/project/cheerp-libs
          command: |
            dch -b -v ${VERSION_NO}-1 "Internal build" -m
            dpkg-buildpackage -d -b

            mv ../cheerp-libs_*.deb ../packages/
      - persist_to_workspace:
          root: packages
          paths:
            - cheerp-*.deb
  test:
    machine: *ubuntu
    resource_class: large
    steps:
      - run: sudo apt-get update && sudo apt-get install -y nodejs
      - attach_workspace:
          at: packages
      - run:
          name: Get tests
          command: |
            if [ << pipeline.parameters.tag >> != master ]; then
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-utils.git
            else
              git clone --depth=1 --branch << pipeline.parameters.cheerp-utils-branch >> https://github.com/leaningtech/cheerp-utils.git
            fi
      - run:
          name: Set up cheerp compiler
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-llvm-clang_*.deb tmp
            sudo mkdir /opt/cheerp/
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp
            rm -rf tmp
      - run:
          name: Set up utils
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-utils_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp      - persist_to_workspace:
          root: packages
          paths:
            - cheerp-*.deb
      - run:
          name: Set up newlib
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-newlib_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp
      - run:
          name: Set up libcxxi
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-libcxx_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp
      - run:
          name: Set up libcxxabi
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-libcxx_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp
      - run:
          name: Set up libs
          working_directory: ~/project/packages
          command: |
            mkdir tmp
            dpkg -x cheerp-libs_*.deb tmp
            sudo cp -rv tmp/opt/cheerp/* /opt/cheerp/
            rm -rf tmp
      - run:
          name: test
          working_directory: ~/project/cheerp-utils/tests
          command: ./run_tests.py --all --determinism=3 --determinism-probability=0.2 "/opt/cheerp/bin/clang++" "node --experimental-wasm-reftypes" -j4
          no_output_timeout: 30m
      - store_artifacts:
          path: ~/project/packages
  RPM-cheerp-compiler:
    docker:
      - image: leaningtech/cheerp_rpm_base:8
    resource_class: large
    environment:
      - THREADS: 6
    steps:
      - attach_workspace:
          at: ~/
      - run: cat ~/version >> $BASH_ENV
      - add_ssh_keys:
          fingerprints:
            - "8f:3f:25:98:2e:d5:1e:9f:0f:e9:dc:8a:fc:46:90:50"
      - run:
          name: Add known hosts
          command: |
            echo $RPM_HOST >> ~/.ssh/known_hosts
            echo $GH_HOST >> ~/.ssh/known_hosts
      - run:
          name: Set up environment
          working_directory: ~/
          command: |
            if [ << pipeline.parameters.tag >> != master ]; then
              echo "export CHAN=stable" >> $BASH_ENV
            else
              echo "export CHAN=nightly" >> $BASH_ENV
            fi
            export REPO_DIR=${PWD}/REPO
            echo "export REPO_DIR=$REPO_DIR" >> $BASH_ENV
            mkdir -p $REPO_DIR
      - run:
          name: Persist environment variables
          command: |
           echo "export CHAN=$CHAN" >> ~/version
           echo "export REPO_DIR=$REPO_DIR" >> ~/version
      - add-yum-configuration
      - get-rpm-repo
      - run:
          name: Get sources
          command: |
            git clone git@github.com:leaningtech/cheerp-internal.git
            if [ << pipeline.parameters.tag >> != master ]; then
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-compiler.git cheerp-llvm-clang
            else
              git clone --depth=1 --branch << pipeline.parameters.cheerp-compiler-branch >> https://github.com/leaningtech/cheerp-compiler.git cheerp-llvm-clang
            fi
      - set-up-rpm-workspace
      - add-rpm-sources:
          directory: cheerp-llvm-clang
          package-name: llvm-clang
          branch-name: << pipeline.parameters.cheerp-compiler-branch >>
      - build-deploy-rpm:
          directory: cheerp-llvm-clang
          package-name: llvm-clang
      - persist_to_workspace:
          root: ~/
          paths:
            - version/
  RPM-libraries:
    docker:
      - image: leaningtech/cheerp_rpm_base:8
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/
      - run: cat ~/version >> $BASH_ENV
      - add_ssh_keys:
          fingerprints:
            - "8f:3f:25:98:2e:d5:1e:9f:0f:e9:dc:8a:fc:46:90:50"
      - run:
          name: Add known hosts
          command: |
            echo $GH_HOST >> ~/.ssh/known_hosts
            echo $RPM_HOST >> ~/.ssh/known_hosts
      - run:
          name: Get repos
          command: |
            git clone git@github.com:leaningtech/cheerp-internal.git
            if [ << pipeline.parameters.tag >> != master ]; then
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-compiler.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-newlib.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-libs.git
              git clone --depth=1 --branch << pipeline.parameters.tag >> https://github.com/leaningtech/cheerp-utils.git
            else
              git clone --depth=1 --branch << pipeline.parameters.cheerp-compiler-branch >> https://github.com/leaningtech/cheerp-compiler.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-newlib-branch >> https://github.com/leaningtech/cheerp-newlib.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-libs-branch >> https://github.com/leaningtech/cheerp-libs.git
              git clone --depth=1 --branch << pipeline.parameters.cheerp-utils-branch >> https://github.com/leaningtech/cheerp-utils.git
            fi
      - get-rpm-repo
      - add-yum-configuration
      - set-up-rpm-workspace
      - run: dnf install -y cheerp-llvm-clang-${VERSION_NO}-1.el8
      - create-rpm-package:
          directory: cheerp-utils
          package-name: utils
          branch-name: << pipeline.parameters.cheerp-utils-branch >>
      - run:
          name: Add cheerp-newlib sources
          working_directory: ~/project/cheerp-newlib
          command: |
            if [ << pipeline.parameters.tag >> != master ]; then
              export NEWLIB_TAG=<< pipeline.parameters.tag >>
              export CHEERP_COMPILER_TAG=<< pipeline.parameters.tag >>
            else
              export NEWLIB_TAG=<< pipeline.parameters.cheerp-newlib-branch >>
              export CHEERP_COMPILER_TAG=<< pipeline.parameters.cheerp-compiler-branch >>
            fi

            MAIN_ARCHIVE=../pkg/cheerp-newlib_${VERSION_NO}.orig.tar.gz
            LIBCXX_ARCHIVE=../pkg/cheerp-newlib_${VERSION_NO}.orig-libcxx.tar.gz
            PREFIX=cheerp-newlib-${VERSION_NO}

            git archive --format=tar.gz --prefix=$PREFIX/ ${NEWLIB_TAG} -o $MAIN_ARCHIVE
            git -C ../cheerp-compiler/ archive --format=tar.gz ${CHEERP_COMPILER_TAG} libcxx/ -o $LIBCXX_ARCHIVE

            rm -rf rpmbuild/SOURCES
            mkdir rpmbuild/SOURCES
            mv ../pkg/* rpmbuild/SOURCES
      - build-deploy-rpm:
          directory: cheerp-newlib
          package-name: newlib
      - run:
          name: Set up for libcxx
          working_directory: ~/project/cheerp-compiler
          command: |
            rm -rf rpmbuild
            cp -r libcxx/rpmbuild .
      - create-rpm-package:
          directory: cheerp-compiler
          package-name: libcxx
          branch-name: << pipeline.parameters.cheerp-compiler-branch >>
      - run:
          name: Set up for libcxxabi
          working_directory: ~/project/cheerp-compiler
          command: |
            rm -rf rpmbuild
            cp -r libcxxabi/rpmbuild .
      - create-rpm-package:
          directory: cheerp-compiler
          package-name: libcxxabi
          branch-name: << pipeline.parameters.cheerp-compiler-branch >>
      - create-rpm-package:
          directory: cheerp-libs
          package-name: libs
          branch-name: << pipeline.parameters.cheerp-libs-branch >>
      - build-deploy-rpm:
          directory: cheerp-internal/tools/releasing/cheerp-core
          package-name: core
      - when:
          condition:
            equal: [ master, << pipeline.parameters.tag >> ]
          steps:
            - run:
                name: Remove old packages
                working_directory: ~/
                command: |
                  if [ ${CHAN} == 'nightly' ]; then
                    . ~/project/cheerp-internal/tools/releasing/rpm_utils.sh
                    repo_remove_old llvm-clang
                    repo_remove_old utils
                    repo_remove_old newlib
                    repo_remove_old libcxx
                    repo_remove_old libcxxabi
                    repo_remove_old libs
                    repo_remove_old core
                    repo_update
                  fi

commands:
  add-yum-configuration:
    steps:
      - run:
          name: Add yum configuration
          command: |
            if [ << pipeline.parameters.tag >> != "master" ]; then

            cat \<< EOF > /etc/yum.repos.d/cheerp.repo
            [Cheerp-Stable]
            name=Cheerp Stable
            gpgcheck=1
            gpgkey=https://rpm.leaningtech.com/RPM-GPG-KEY-leaningtech
            enabled=1
            baseurl=https://rpm.leaningtech.com/stable
            EOF

            else

            cat \<< EOF > /etc/yum.repos.d/cheerp.repo
            [Cheerp-Nightly]
            name=Cheerp Nightly
            gpgcheck=1
            gpgkey=https://rpm.leaningtech.com/RPM-GPG-KEY-leaningtech
            enabled=1
            baseurl=https://rpm.leaningtech.com/nightly
            EOF

            fi
  set-up-rpm-workspace:
    steps:
      - run:
          name: Set up workspace
          command: |
            mkdir pkg
            echo -e $GPG_KEY | gpg --import
            echo -e $PUBLIC_GPG_KEY > public
            rpm --import public
            rm public
            echo "%_signature gpg" >> ~/.rpmmacros
            echo "%_gpg_name Alessandro Pignotti" >> ~/.rpmmacros
  get-rpm-repo:
    steps:
     - run:
          name: Get RPM repo
          working_directory: ~/
          command: |
              rsync -a --delete-after -e 'ssh -p 2223' leaningtech@136.243.170.209:/srv/web/rpm/$CHAN ${REPO_DIR}/
  create-rpm-package:
    parameters:
      directory:
        type: string
      package-name:
        type: string
      branch-name:
        type: string
        default: master
    steps:
      - add-rpm-sources:
          directory: << parameters.directory >>
          package-name: << parameters.package-name >>
          branch-name: << parameters.branch-name >>
      - build-deploy-rpm:
          directory: << parameters.directory >>
          package-name: << parameters.package-name >>
  add-rpm-sources:
    parameters:
      directory:
        type: string
      package-name:
        type: string
      branch-name:
        type: string
        default: master
    steps:
      - run:
          name: Add cheerp-<< parameters.package-name >> sources
          working_directory: ~/project/<< parameters.directory >>
          command: |
            if [ << pipeline.parameters.tag >> != master ]; then
              ../cheerp-internal/tools/releasing/<< parameters.package-name >>_debian_archives.sh ${VERSION_NO} << pipeline.parameters.tag >>
            else
              ../cheerp-internal/tools/releasing/<< parameters.package-name >>_debian_archives.sh ${VERSION_NO} << parameters.branch-name >>
            fi
            rm -rf rpmbuild/SOURCES
            mkdir rpmbuild/SOURCES
            mv ../pkg/* rpmbuild/SOURCES
  build-deploy-rpm:
    parameters:
      directory:
        type: string
      package-name:
        type: string
    steps:
      - run:
          name: Build cheerp-<< parameters.package-name >>
          working_directory: ~/project/<< parameters.directory >>
          command: |
            sed -i "s/Version: .*/Version: ${VERSION_NO}/" rpmbuild/SPECS/cheerp-<< parameters.package-name >>.spec
            rpmbuild -ba rpmbuild/SPECS/cheerp-<< parameters.package-name >>.spec --define "_topdir ${PWD}/rpmbuild"
            rpm --addsign rpmbuild/RPMS/x86_64/cheerp-<< parameters.package-name >>-${VERSION_NO}-1.el8.x86_64.rpm
      - run:
          name: Deploy cheerp-<< parameters.package-name >>
          working_directory: ~/
          command: |
            cp ~/project/<< parameters.directory >>/rpmbuild/RPMS/x86_64/cheerp-<< parameters.package-name >>-${VERSION_NO}-1.el8.x86_64.rpm ${REPO_DIR}/${CHAN}
            . ~/project/cheerp-internal/tools/releasing/rpm_utils.sh
            repo_update
      - run:
          name: Install cheerp-<< parameters.package-name >>-${VERSION_NO}-1.el8
          working_directory: ~/
          command: |
            dnf clean all
            dnf install -y cheerp-<< parameters.package-name >>-${VERSION_NO}-1.el8

parameters:
  tag:
    type: string
    default: "master"
  cheerp-compiler-branch:
    type: string
    default: << pipeline.git.branch >>
  cheerp-utils-branch:
    type: string
    default: "master"
  cheerp-newlib-branch:
    type: string
    default: "master"
  cheerp-libs-branch:
    type: string
    default: "master"

workflows:
  build-cheerp-compiler:
    jobs:
      - define-version-no
      - build-cheerp-compiler:
          requires:
            - define-version-no
      - build-libraries:
          requires:
            - define-version-no
            - build-cheerp-compiler
      - test:
          requires:
            - build-cheerp-compiler
            - build-libraries
      - RPM-cheerp-compiler:
          requires:
            - define-version-no
            - test
      - RPM-libraries:
          requires:
            - RPM-cheerp-compiler
